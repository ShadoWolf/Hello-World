Поправил ошибку с не volatile массивом флагов. Теперь зависать не должно. Плюс немного унифицировал нити.